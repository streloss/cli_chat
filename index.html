<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CLI Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
body { margin:0; background:#0a0a0a; color:#fff; font-family:monospace; line-height:1.5; }
#top { position:fixed; top:0; left:0; width:100%; padding:10px 15px; background:#111; border-bottom:1px solid #333; z-index:10; display:flex; justify-content:space-between; align-items:center; }
#online { cursor:pointer; color:#0f0; font-weight:bold; }
#onlineList, #friendsList { display:none; position:absolute; top:50px; left:15px; background:#1a1a1a; border:1px solid #333; border-radius:8px; padding:12px; width:220px; box-shadow:0 4px 20px rgba(0,0,0,0.6); font-size:13px; }
#terminal { padding:70px 15px 130px; height:100vh; overflow-y:auto; background:#0a0a0a; white-space:pre-wrap; word-wrap:break-word; }
#input { position:fixed; bottom:30px; left:15px; right:15px; background:#1a1a1a; color:#fff; border:1px solid #444; border-radius:6px; outline:none; font-size:16px; padding:10px 15px; box-sizing:border-box; }
#status { position:fixed; bottom:0; left:0; width:100%; padding:8px 15px; font-size:13px; background:#111; color:#888; border-top:1px solid #333; }
.creator-tag { color:#ff6666; font-size:14px; font-weight:bold; margin-right:6px; }
.admin-nick { color:#ffaaaa; font-weight:bold; }
.owner-nick { color:#ff4444; font-weight:bold; }
.friend-star { color:#0f0; margin-left:4px; }
.message { margin-bottom:8px; }
.time { color:#666; margin-right:8px; }
.nick { margin-right:4px; }
</style>
</head>
<body>

<div id="top">
  <span id="online">–í —Å–µ—Ç–∏: 0</span>
  <div>
    <span id="friendsBtn" style="cursor:pointer;color:#0af;margin-right:20px;">–î—Ä—É–∑—å—è</span>
  </div>
</div>

<div id="onlineList"></div>
<div id="friendsList" style="display:none;"></div>

<div id="terminal"></div>

<input id="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ ‚Üí Enter">

<div id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
<div id="typing" style="font-size:13px;color:#777;padding:4px 15px;display:none;position:fixed;bottom:70px;left:0;width:100%">‚úçÔ∏è –∫—Ç–æ-—Ç–æ –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶</div>

<script>
window.addEventListener('load', () => {
  if (typeof firebase === 'undefined') return;

  const config = { /* —Ç–≤–æ–π firebase config –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */ 
    apiKey: "AIzaSyBzPbPhYS7dDfhDwaqYLAHpIV6QBN53EV0",
    authDomain: "project-7979939474542798395.firebaseapp.com",
    databaseURL: "https://project-7979939474542798395-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "project-7979939474542798395",
    storageBucket: "project-7979939474542798395.firebasestorage.app",
    messagingSenderId: "64773662070",
    appId: "1:64773662070:web:59a5ade363119a1b61c657"
  };
  firebase.initializeApp(config);
  const db = firebase.database();

  let username = localStorage.getItem('nick') || prompt('–ù–∏–∫');
  localStorage.setItem('nick', username);
  let role = localStorage.getItem('role') || 'USER';
  const PASSWORD = 'sayayo';

  const messagesRef = db.ref('messages');
  const onlineRef = db.ref('online/' + username);
  const friendsRef = db.ref('friends/' + username);
  const typingRef = db.ref('typing');
  const typingUserRef = db.ref('typing/' + username);

  onlineRef.set({device: getDevice(), time: Date.now()});
  onlineRef.onDisconnect().remove();

  const terminal = document.getElementById('terminal');
  const input = document.getElementById('input');
  const statusEl = document.getElementById('status');
  const onlineEl = document.getElementById('online');
  const onlineListEl = document.getElementById('onlineList');
  const friendsBtn = document.getElementById('friendsBtn');
  const friendsListEl = document.getElementById('friendsList');

  function getDevice() { /* —Ç–≤–æ—è —Ñ—É–Ω–∫—Ü–∏—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */ 
    /* ... (–æ—Å—Ç–∞–≤—å –∫–∞–∫ –±—ã–ª–æ) ... */
    return 'üñ•Ô∏è Desktop';
  }

  function system(msg) {
    terminal.innerHTML += `<div style="color:#777">[SYSTEM] ${msg}</div>`;
    terminal.scrollTop = terminal.scrollHeight;
  }

  // –û–Ω–ª–∞–π–Ω
  db.ref('online').on('value', snap => {
    const users = snap.val() || {};
    let count = 0, html = '';
    for (let u in users) {
      if (users[u]) {
        count++;
        html += `${u} <span style="color:#0c0">${users[u].device}</span><br>`;
      }
    }
    onlineEl.textContent = `–í —Å–µ—Ç–∏: ${count}`;
    onlineListEl.innerHTML = html || '(–ø—É—Å—Ç–æ)';
  });

  onlineEl.onclick = () => onlineListEl.style.display = onlineListEl.style.display === 'block' ? 'none' : 'block';

  // –î—Ä—É–∑—å—è
  let friends = [];
  friendsRef.on('value', snap => {
    friends = snap.val() || [];
    renderFriendsList();
  });

  function renderFriendsList() {
    let html = '<b>–î—Ä—É–∑—å—è:</b><br>';
    if (friends.length === 0) html += '(–ø—É—Å—Ç–æ)';
    friends.forEach(f => html += `‚≠ê ${f}<br>`);
    friendsListEl.innerHTML = html;
  }

  friendsBtn.onclick = () => friendsListEl.style.display = friendsListEl.style.display === 'block' ? 'none' : 'block';

  // –°–æ–æ–±—â–µ–Ω–∏—è (—Ç–µ–∫—Å—Ç –≤—Å–µ–≥–¥–∞ –±–µ–ª—ã–π)
  messagesRef.limitToLast(100).on('child_added', snap => {
    const m = snap.val();
    if (!m?.user || !m?.text) return;

    let nickClass = m.role === 'OWNER' ? 'owner-nick' : m.role === 'ADMIN' ? 'admin-nick' : '';
    let tag = m.role === 'OWNER' ? '<span class="creator-tag">[—Å–æ–∑–¥–∞—Ç–µ–ª—å]</span> ' : '';

    const isFriend = friends.includes(m.user) ? '<span class="friend-star">‚≠ê</span>' : '';

    terminal.innerHTML += `
      <div class="message">
        <span class="time">[${m.time || '--:--'}]</span>
        ${tag}
        <span class="${nickClass}">${m.user}</span>${isFriend}
        <span style="color:#888"> : </span>
        <span style="color:#ffffff">${m.text}</span>
      </div>`;
    terminal.scrollTop = terminal.scrollHeight;
  });

  // –í–≤–æ–¥
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      let t = input.value.trim();
      if (!t) return;
      typingUserRef.remove();

      if (t.startsWith('/key ')) {
        const p = t.split(' ');
        if (p[2] === PASSWORD) {
          role = p[1] === 'owner' ? 'OWNER' : p[1] === 'admin' ? 'ADMIN' : role;
          localStorage.setItem('role', role);
          system('–†–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞');
        } else system('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
        input.value = '';
        return;
      }

      if (t === '/clear' && (role === 'OWNER' || role === 'ADMIN')) {
        messagesRef.remove();
        terminal.innerHTML = '';
        system('–ß–∞—Ç –æ—á–∏—â–µ–Ω');
        input.value = '';
        return;
      }

      if (t.startsWith('/friend add ')) {
        const friendName = t.slice(12).trim();
        if (friendName && friendName !== username) {
          friends.push(friendName);
          friendsRef.set(friends);
          system(`–î–æ–±–∞–≤–ª–µ–Ω –≤ –¥—Ä—É–∑—å—è: ${friendName}`);
        }
        input.value = '';
        return;
      }

      if (t === '/friend list') {
        system('–î—Ä—É–∑—å—è: ' + (friends.length ? friends.join(', ') : '–ø—É—Å—Ç–æ'));
        input.value = '';
        return;
      }

      messagesRef.push({
        user: username,
        role: role,
        text: t,
        time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
      });
      input.value = '';
    } else if (e.key.length === 1 || e.key === 'Backspace') {
      typingUserRef.set(true);
      typingUserRef.onDisconnect().remove();
    }
  });

  // –û—Å—Ç–∞–ª—å–Ω–æ–µ (—Å—Ç–∞—Ç—É—Å, typing) –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  db.ref('.info/connected').on('value', s => {
    statusEl.innerHTML = s.val() ? '<span style="color:#0f0">‚óè –û–Ω–ª–∞–π–Ω</span>' : '<span style="color:#f44">‚óè –û—Ñ—Ñ–ª–∞–π–Ω</span>';
  });

  typingRef.on('value', s => {
    const others = Object.keys(s.val() || {}).filter(u => u !== username);
    typingEl.style.display = others.length ? 'block' : 'none';
    typingEl.textContent = others.length ? '‚úçÔ∏è –ü–µ—á–∞—Ç–∞–µ—Ç: ' + others.join(', ') : '';
  });
});
</script>
</body>
</html>
