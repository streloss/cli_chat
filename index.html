<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CLI Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
body{margin:0;background:#000;color:#fff;font-family:monospace;line-height:1.4}
#top{position:fixed;top:0;left:0;width:100%;padding:8px 12px;border-bottom:1px solid #222;background:#000;z-index:10}
#online{cursor:pointer;color:#0f0}
#onlineList{display:none;font-size:13px;color:#aaa;padding:10px;background:#111;border:1px solid #333;border-radius:6px;max-height:400px;overflow-y:auto}
#terminal{padding:60px 12px 110px;height:100vh;overflow-y:auto;white-space:pre-wrap}
#input{position:fixed;bottom:28px;left:0;width:100%;background:#000;color:#fff;border:none;outline:none;font-size:16px;padding:8px 12px;box-sizing:border-box}
#status{position:fixed;bottom:0;left:0;width:100%;padding:6px 12px;font-size:13px;border-top:1px solid #222;color:#888}
.creator-tag{color:#ff6666;font-size:14px;font-weight:bold;margin-right:6px}
.admin-nick{color:#ffaaaa;font-weight:bold}
.owner-nick{color:#ff4444;font-weight:bold}
.ip-info {color:#888;font-size:11px;margin-left:6px}
.flag {font-size:14px;margin-right:4px}
</style>
</head>
<body>

<div id="top">
  <span id="online">–í —Å–µ—Ç–∏: 0</span>
  <div id="onlineList"></div>
</div>

<div id="terminal"></div>

<input id="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ ‚Üí Enter">

<div id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
<div id="typing" style="font-size:13px;color:#777;padding:4px 12px;display:none;position:fixed;bottom:60px;left:0;width:100%">‚úçÔ∏è –∫—Ç–æ-—Ç–æ –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶</div>

<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–ª–∞–≥–∞ –ø–æ –∫–æ–¥—É —Å—Ç—Ä–∞–Ω—ã (ISO 3166-1 alpha-2)
function getFlagEmoji(countryCode) {
  if (!countryCode || countryCode.length !== 2) return '';
  const codePoints = countryCode
    .toUpperCase()
    .split('')
    .map(char => 127397 + char.charCodeAt(0));
  return String.fromCodePoint(...codePoints);
}

// –ü–æ–ª—É—á–∞–µ–º IP –∏ –≥–µ–æ-–¥–∞–Ω–Ω—ã–µ
async function getGeoInfo() {
  try {
    const res = await fetch('https://ipapi.co/json/');
    const data = await res.json();
    return {
      ip: data.ip || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
      country: data.country_name || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
      countryCode: data.country_code || '',
      city: data.city || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
    };
  } catch {
    return { ip: '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', country: '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', countryCode: '', city: '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' };
  }
}

let myGeo = { ip: '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', country: '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', countryCode: '', city: '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' };
getGeoInfo().then(geo => myGeo = geo);

window.addEventListener('load', () => {
  if (typeof firebase === 'undefined') return;

  const config = {
    apiKey: "AIzaSyBzPbPhYS7dDfhDwaqYLAHpIV6QBN53EV0",
    authDomain: "project-7979939474542798395.firebaseapp.com",
    databaseURL: "https://project-7979939474542798395-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "project-7979939474542798395",
    storageBucket: "project-7979939474542798395.firebasestorage.app",
    messagingSenderId: "64773662070",
    appId: "1:64773662070:web:59a5ade363119a1b61c657"
  };
  firebase.initializeApp(config);
  const db = firebase.database();

  let username = localStorage.getItem('nick') || prompt('–í–∞—à –Ω–∏–∫');
  localStorage.setItem('nick', username);
  let role = localStorage.getItem('role') || 'USER';
  const PASSWORD = 'sayayo';

  const messagesRef = db.ref('messages');
  const onlineRef = db.ref('online/' + username);
  const typingRef = db.ref('typing');
  const typingUserRef = db.ref('typing/' + username);

  onlineRef.set({
    username: username,
    role: role,
    geo: myGeo,
    time: Date.now(),
    device: navigator.userAgent.includes('Mobile') ? 'üì±' : 'üñ•Ô∏è'
  });
  onlineRef.onDisconnect().remove();

  const terminal = document.getElementById('terminal');
  const input = document.getElementById('input');
  const statusEl = document.getElementById('status');
  const onlineEl = document.getElementById('online');
  const onlineListEl = document.getElementById('onlineList');

  function system(msg) {
    terminal.innerHTML += `<div style="color:#777">[SYSTEM] ${msg}</div>`;
    terminal.scrollTop = terminal.scrollHeight;
  }

  // –°–ø–∏—Å–æ–∫ –æ–Ω–ª–∞–π–Ω —Å —Ñ–ª–∞–≥–∞–º–∏
  db.ref('online').on('value', snap => {
    const users = snap.val() || {};
    let count = 0;
    let html = '';

    for (let uid in users) {
      const u = users[uid];
      if (!u) continue;
      count++;

      let line = u.username || uid;

      // –§–ª–∞–≥ + —Å—Ç—Ä–∞–Ω–∞ + –≥–æ—Ä–æ–¥ (–≤—Å–µ–º –≤–∏–¥–Ω–æ)
      if (u.geo && u.geo.country !== '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') {
        const flag = getFlagEmoji(u.geo.countryCode);
        line += ` <span class="flag">${flag}</span>${u.geo.country}, ${u.geo.city}`;
      }

      // IP –≤–∏–¥–Ω–æ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º
      if ((role === 'ADMIN' || role === 'OWNER') && u.geo?.ip) {
        line += ` <span class="ip-info">[IP: ${u.geo.ip}]</span>`;
      }

      html += `<div>${line}</div>`;
    }

    onlineEl.textContent = `–í —Å–µ—Ç–∏: ${count}`;
    onlineListEl.innerHTML = html || '(–ø—É—Å—Ç–æ)';
  });

  onlineEl.onclick = () => {
    onlineListEl.style.display = onlineListEl.style.display === 'block' ? 'none' : 'block';
  };

  // –°–æ–æ–±—â–µ–Ω–∏—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
  messagesRef.limitToLast(100).on('child_added', snap => {
    const m = snap.val();
    if (!m?.user || !m?.text) return;

    let nickClass = '';
    let tag = '';

    if (m.role === 'OWNER') {
      nickClass = 'owner-nick';
      tag = '<span class="creator-tag">[—Å–æ–∑–¥–∞—Ç–µ–ª—å]</span>&nbsp;';
    } else if (m.role === 'ADMIN') {
      nickClass = 'admin-nick';
    }

    const safeText = String(m.text)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');

    terminal.innerHTML += 
      '<div>' +
        '<span style="color:#555">[' + (m.time || '--:--') + '] </span>' +
        tag +
        '<span class="' + nickClass + '">' + m.user + '</span>' +
        '<span style="color:#888">&nbsp;:&nbsp;</span>' +
        '<span style="color:#ffffff">' + safeText + '</span>' +
      '</div>';

    terminal.scrollTop = terminal.scrollHeight;
  });

  // –í–≤–æ–¥
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const t = input.value.trim();
      if (!t) return;
      typingUserRef.remove();

      if (t.startsWith('/key ')) {
        const p = t.split(' ');
        if (p[2] !== PASSWORD) {
          system('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
          input.value = '';
          return;
        }
        const nr = p[1].toLowerCase();
        if (nr === 'owner') {
          role = 'OWNER';
          localStorage.setItem('role', 'OWNER');
          system('–í—ã OWNER');
        } else if (nr === 'admin') {
          role = 'ADMIN';
          localStorage.setItem('role', 'ADMIN');
          system('–í—ã ADMIN');
        }
        input.value = '';
        return;
      }

      if (t === '/clear' && (role === 'OWNER' || role === 'ADMIN')) {
        messagesRef.remove();
        terminal.innerHTML = '';
        system('–ß–∞—Ç –æ—á–∏—â–µ–Ω');
        input.value = '';
        return;
      }

      messagesRef.push({
        user: username,
        role: role,
        text: t,
        time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
      });
      input.value = '';
    } else if (e.key.length === 1 || e.key === 'Backspace') {
      typingUserRef.set(true);
      typingUserRef.onDisconnect().remove();
    }
  });

  db.ref('.info/connected').on('value', snap => {
    statusEl.innerHTML = snap.val() ? '<span style="color:#0f0">‚óè –û–Ω–ª–∞–π–Ω</span>' : '<span style="color:#f44">‚óè –û—Ñ—Ñ–ª–∞–π–Ω</span>';
  });

  typingRef.on('value', snap => {
    const others = Object.keys(snap.val() || {}).filter(u => u !== username);
    typingEl.style.display = others.length ? 'block' : 'none';
    typingEl.textContent = others.length ? '‚úçÔ∏è –ü–µ—á–∞—Ç–∞–µ—Ç: ' + others.join(', ') : '';
  });
});
</script>
</body>
</html>
