<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CLI Chat ALPHA</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Firebase (–¢–û–õ–¨–ö–û –û–î–ò–ù –†–ê–ó) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
body{margin:0;background:#000;color:#fff;font-family:monospace}
#top{position:fixed;top:0;left:0;width:100%;padding:6px 10px;border-bottom:1px solid #222;background:#000}
#online{cursor:pointer;color:#0f0}
#onlineList{display:none;font-size:13px;color:#aaa;line-height:1.4}
#terminal{padding:50px 10px 90px;height:100vh;overflow-y:auto;white-space:pre-wrap}
#input{position:fixed;bottom:28px;left:0;width:100%;background:#000;color:#fff;border:none;outline:none;font-family:monospace;font-size:16px;padding:6px 10px}
#status{position:fixed;bottom:0;left:0;width:100%;padding:6px 10px;font-size:13px;border-top:1px solid #222;color:#888}
.owner{color:red;font-weight:bold}
.admin{color:#ff5555}
</style>
</head>
<body>
<div id="top">
  <span id="online">–í —Å–µ—Ç–∏: 0</span>
  <div id="onlineList"></div>
</div>
<div id="terminal"></div>
<input id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ Enter">
<div id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
<div id="typing" style="font-size:13px;color:#aaa;padding:4px 10px;display:none">
  ‚úçÔ∏è –∫—Ç–æ-—Ç–æ –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶
</div>

<script>
/* ===== –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (2025‚Äì2026) ===== */
function getDevice() {
  const ua = navigator.userAgent.toLowerCase();
  const w = window.innerWidth || screen.width;
  const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

  // iOS
  if (/ipad|ipod|iphone/.test(ua) && !/windows/.test(ua)) {
    if (ua.includes('ipad') || (hasTouch && w >= 768)) return 'üì± iPad';
    return 'üì± iPhone';
  }

  // Android
  if (ua.includes('android')) {
    if (hasTouch && w >= 768) return 'üì± Android Tablet';
    return 'üì± Android Phone';
  }

  // –î—Ä—É–≥–∏–µ –º–æ–±–∏–ª—å–Ω—ã–µ / touch-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  if (hasTouch) {
    if (w >= 1024) return 'üñ•Ô∏è Touch / 2-in-1';
    if (w >= 600)  return 'üì± Large Phone / Small Tablet';
    return 'üì± Phone';
  }

  // –î–µ—Å–∫—Ç–æ–ø—ã
  if (ua.includes('mac'))     return 'üñ•Ô∏è Mac';
  if (ua.includes('windows')) return 'üñ•Ô∏è Windows';
  if (ua.includes('linux'))   return 'üñ•Ô∏è Linux';

  return 'üñ•Ô∏è Desktop / Laptop';
}

var PASSWORD = 'sayayo';
var firebaseConfig = {
  apiKey: "AIzaSyBzPbPhYS7dDfhDwaqYLAHpIV6QBN53EV0",
  authDomain: "project-7979939474542798395.firebaseapp.com",
  databaseURL: "https://project-7979939474542798395-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "project-7979939474542798395",
  storageBucket: "project-7979939474542798395.firebasestorage.app",
  messagingSenderId: "64773662070",
  appId: "1:64773662070:web:59a5ade363119a1b61c657"
};

firebase.initializeApp(firebaseConfig);
var db = firebase.database();

var username = localStorage.getItem('nick');
if (!username) {
  username = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫');
  localStorage.setItem('nick', username);
}

var role = localStorage.getItem('role') || 'USER';
var color = localStorage.getItem('color');
if (!color) {
  var arr = ['#ff5555','#55ff55','#5555ff','#ffaa00','#00ffaa','#aa00ff'];
  color = arr[Math.floor(Math.random()*arr.length)];
  localStorage.setItem('color', color);
}

var messagesRef = db.ref('messages');
var onlineRef   = db.ref('online/' + username);
var device      = getDevice();

var typingRef     = db.ref('typing');
var typingUserRef = db.ref('typing/' + username);
var typingEl      = document.getElementById('typing');

onlineRef.set({ device: device, time: Date.now() });
onlineRef.onDisconnect().remove();

var terminal    = document.getElementById('terminal');
var input       = document.getElementById('input');
var statusEl    = document.getElementById('status');
var onlineEl    = document.getElementById('online');
var onlineListEl= document.getElementById('onlineList');

function system(msg) {
  terminal.innerHTML += '<div style="color:#888">[SYSTEM] ' + msg + '</div>';
  terminal.scrollTop = terminal.scrollHeight;
}

db.ref('online').on('value', function(s) {
  var users = s.val() || {};
  var list = [];
  var count = 0;
  for (var u in users) {
    if (users[u] && users[u].device) {
      list.push(u + ' <span style="color:#0a0">' + users[u].device + '</span>');
      count++;
    }
  }
  onlineEl.textContent = '–í —Å–µ—Ç–∏: ' + count;
  onlineListEl.innerHTML = list.join('<br>') || '(–ø—É—Å—Ç–æ)';
});

onlineEl.onclick = function() {
  onlineListEl.style.display = onlineListEl.style.display === 'block' ? 'none' : 'block';
};

messagesRef.limitToLast(100).on('child_added', function(s) {
  var m = s.val();
  var roleClass = '';
  if (m.role === 'OWNER') roleClass = 'owner';
  if (m.role === 'ADMIN') roleClass = 'admin';

  terminal.innerHTML +=
    '<div>' +
      '[' + m.time + '] ' +
      '<span class="' + roleClass + '">' + m.user + '</span>' +
      ': <span style="color:' + m.color + '">' + m.text + '</span>' +
    '</div>';
  terminal.scrollTop = terminal.scrollHeight;
});

input.addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    var t = input.value.trim();
    if (!t) return;

    typingUserRef.remove();

    if (t.startsWith('/key ')) {
      var p = t.split(' ');
      if (p[2] !== PASSWORD) { system('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'); input.value=''; return; }
      if (p[1] === 'owner') { role='OWNER'; localStorage.setItem('role','OWNER'); system('–í—ã OWNER'); }
      if (p[1] === 'admin') { role='ADMIN'; localStorage.setItem('role','ADMIN'); system('–í—ã ADMIN'); }
      input.value = '';
      return;
    }

    if (t === '/clear') {
      if (role === 'OWNER' || role === 'ADMIN') {
        messagesRef.remove();
        terminal.innerHTML = '';
        system('–ß–∞—Ç –æ—á–∏—â–µ–Ω');
      } else {
        system('–ù–µ—Ç –ø—Ä–∞–≤');
      }
      input.value = '';
      return;
    }

    messagesRef.push({
      user: username,
      role: role,
      text: t,
      time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
      color: color
    });
    input.value = '';
  } else {
    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –ø–µ—á–∞—Ç–∞–µ–º
    typingUserRef.set(true);
    typingUserRef.onDisconnect().remove();
  }
});

db.ref('.info/connected').on('value', function(s) {
  statusEl.innerHTML = s.val()
    ? '<span style="color:#0f0">‚óè –û–Ω–ª–∞–π–Ω</span>'
    : '<span style="color:#f00">‚óè –û—Ñ—Ñ–ª–∞–π–Ω</span>';
});

typingRef.on('value', function(s) {
  var users = s.val() || {};
  var list = Object.keys(users).filter(u => u !== username);
  if (list.length) {
    typingEl.style.display = 'block';
    typingEl.textContent = '‚úçÔ∏è –ü–µ—á–∞—Ç–∞–µ—Ç: ' + list.join(', ');
  } else {
    typingEl.style.display = 'none';
  }
});
</script>
</body>
</html>
