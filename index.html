<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CLI Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;background:#000;color:#fff;font-family:monospace}
#typing{position:fixed;top:0;left:0;width:100%;padding:6px 12px;color:#0f0;border-bottom:1px solid #222}
#terminal{padding:50px 10px 80px;height:100vh;overflow-y:auto;white-space:pre-wrap}
#input{position:fixed;bottom:28px;left:0;width:100%;background:#000;color:#fff;border:none;outline:none;font-size:16px;padding:6px}
#connection{position:fixed;bottom:0;left:0;width:100%;padding:6px 12px;border-top:1px solid #222;color:#888}
</style>
</head>
<body>

<div id="typing"></div>
<div id="terminal"></div>
<input id="input" placeholder="Введите сообщение и Enter">
<div id="connection">● Инициализация...</div>

<script>
window.addEventListener('load', () => {

const firebaseConfig = {
  apiKey: "AIzaSyBzPbPhYS7dDfhDwaqYLAHpIV6QBN53EV0",
  authDomain: "project-7979939474542798395.firebaseapp.com",
  databaseURL: "https://project-7979939474542798395-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "project-7979939474542798395",
  storageBucket: "project-7979939474542798395.firebasestorage.app",
  messagingSenderId: "64773662070",
  appId: "1:64773662070:web:59a5ade363119a1b61c657"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const terminal = document.getElementById('terminal');
const input = document.getElementById('input');
const typingEl = document.getElementById('typing');
const connectionEl = document.getElementById('connection');

let username = localStorage.getItem('nick');
if(!username){
  username = prompt('Введите ник') || 'user' + Math.floor(Math.random()*1000);
  localStorage.setItem('nick', username);
}

terminal.textContent = 'CLI Chat started\nВаш ник: ' + username + '\n-------------------------\n';

const messagesRef = db.ref('messages');
const typingRef = db.ref('typing');

messagesRef.limitToLast(100).on('value', snap => {
  terminal.innerHTML = '';
  const data = snap.val() || {};
  for(const k in data){
    const m = data[k];
    terminal.innerHTML += `[${m.time}] ${m.user}: ${m.text}\n`;
  }
  terminal.scrollTop = terminal.scrollHeight;
});

input.addEventListener('keydown', e => {
  if(e.key !== 'Enter') return;
  const text = input.value.trim();
  if(!text) return;

  messagesRef.push({
    user: username,
    text: text,
    time: new Date().toLocaleTimeString()
  });

  input.value = '';
  typingRef.child(username).remove();
});

input.addEventListener('input', () => {
  typingRef.child(username).set(true);
  setTimeout(()=>typingRef.child(username).remove(),1500);
});

typingRef.on('value', snap => {
  const u = snap.val() || {};
  const list = Object.keys(u).filter(n=>n!==username);
  typingEl.textContent = list.length ? list.join(', ') + ' печатает...' : '';
});

function updatePing(){
  const start = performance.now();
  db.ref('ping').set(Date.now()).then(()=>{
    const ms = Math.round(performance.now() - start);
    connectionEl.textContent = `● Подключено | ping: ${ms} ms`;
    connectionEl.style.color = '#0f0';
  });
}

db.ref('.info/connected').on('value', snap => {
  if(snap.val()){
    updatePing();
  }else{
    connectionEl.textContent = '● Соединение потеряно';
    connectionEl.style.color = '#f00';
  }
});

setInterval(()=>navigator.onLine && updatePing(),3000);

});
</script>
</body>
</html>
