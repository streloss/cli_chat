<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CLI Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
    margin: 0;
    background: black;
    color: #ffffff;
    font-family: monospace;
    font-size: 16px;
}
#typing {
    padding: 5px 10px;
    color: #888;
    font-size: 14px;
    position: fixed;
    bottom: 55px;
    left: 0;
    width: 100%;
    background: black;
}
#terminal {
    padding: 10px;
    height: calc(100vh - 90px);
    overflow-y: auto;
    white-space: pre-wrap;
}
#input {
    outline: none;
    border: none;
    background: black;
    color: #ffffff;
    font-family: monospace;
    font-size: 16px;
    width: 100%;
    position: fixed;
    bottom: 20px;
    left: 0;
    padding: 5px 10px;
}
#roomBar {
    position: fixed;
    bottom: 80px;
    left: 0;
    width: 100%;
    background: #111;
    color: #fff;
    display: flex;
    justify-content: space-between;
    padding: 5px 10px;
    font-size: 14px;
}
#roomUsers {
    position: fixed;
    bottom: 110px;
    left: 0;
    width: 100%;
    background: #000;
    color: #aaa;
    display: none;
    padding: 5px 10px;
    font-size: 13px;
}
</style>
</head>
<body>

<div id="terminal"></div>
<div id="roomBar">
  <span id="roomCount">ðŸ‘¥ 0</span>
  <span id="toggleBar">â¬†</span>
</div>
<div id="roomUsers"></div>
<div id="typing"></div>
<input id="input" autocomplete="off" autofocus placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Enter">

<script>
const terminal = document.getElementById('terminal');
const input = document.getElementById('input');
const typingEl = document.getElementById('typing');

const username = 'user_' + Math.floor(Math.random() * 1000);
let isAdmin = false;
const ADMIN_IP = '45.134.218.211';

// Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ IP Ð¸ Ð¿Ñ€Ð°Ð²Ð° Ð°Ð´Ð¼Ð¸Ð½Ð°
fetch('https://api.ipify.org?format=json')
  .then(res => res.json())
  .then(data => {
      if (data.ip === ADMIN_IP) {
          isAdmin = true;
          terminal.textContent += '
[ADMIN MODE ENABLED]
';
      }
  })
  .catch(() => {});

const firebaseConfig = {
  apiKey: "AIzaSyBzPbPhYS7dDfhDwaqYLAHpIV6QBN53EV0",
  authDomain: "project-7979939474542798395.firebaseapp.com",
  databaseURL: "https://project-7979939474542798395-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "project-7979939474542798395",
  storageBucket: "project-7979939474542798395.firebasestorage.app",
  messagingSenderId: "64773662070",
  appId: "1:64773662070:web:59a5ade363119a1b61c657",
  measurementId: "G-FP4X149HMS"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const messagesRef = db.ref('messages');
const typingRef = db.ref('typing');
const usersRef = db.ref('presence');

function renderMessages(data) {
    terminal.textContent = '';
    Object.values(data || {}).forEach(m => {
        terminal.textContent += `[${m.time}] ${m.user}: ${m.text}\n`;
    });
    terminal.scrollTop = terminal.scrollHeight;
}

messagesRef.limitToLast(100).on('value', snap => {
    renderMessages(snap.val());
});

input.addEventListener('keydown', e => {
    if (e.key !== 'Enter') return;

    const text = input.value.trim();
    if (!text) return;

    // ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð°)
    if (text === '/clear') {
        if (!isAdmin) {
            terminal.textContent += '[SYSTEM] ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð¿Ñ€Ð°Ð² Ð´Ð»Ñ /clear
';
            input.value = '';
            return;
        }
        messagesRef.remove();
        terminal.textContent = '';
        input.value = '';
        return;
    }
    }

    messagesRef.push({
        user: username,
        text: text,
        time: new Date().toLocaleTimeString()
    });

    input.value = '';
    typingRef.child(username).remove();
});
        input.value = '';
        typingRef.child(username).remove();
    }
});

input.addEventListener('input', () => {
    typingRef.child(username).set(true);
    setTimeout(() => typingRef.child(username).remove(), 1500);
});

typingRef.on('value', snap => {
    const users = snap.val() || {};
    const others = Object.keys(users).filter(u => u !== username);
    typingEl.textContent = others.length ? others.join(', ') + ' Ð¿ÐµÑ‡Ð°Ñ‚Ð°ÐµÑ‚...' : '';
});

// Ð¾Ð½Ð»Ð°Ð¹Ð½ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ (presence)
const myPresenceRef = usersRef.child(username);

// ÑÑ‚Ð°Ð²Ð¸Ð¼ Ð¾Ð½Ð»Ð°Ð¹Ð½ ÐŸÐžÐ¡Ð›Ð• Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ðº Firebase
firebase.database().ref('.info/connected').on('value', snap => {
    if (snap.val() === true) {
        myPresenceRef.set(true);
        myPresenceRef.onDisconnect().remove();
    }
});

usersRef.on('value', snap => {
    const users = snap.val() || {};
    const names = Object.keys(users);
    document.getElementById('roomCount').textContent = `ðŸ‘¥ ${names.length}`;
    document.getElementById('roomUsers').textContent = 'Ð’ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ðµ: ' + (names.length ? names.join(', ') : 'Ð½Ð¸ÐºÐ¾Ð³Ð¾');
});

// Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð°Ñ Ð¿Ð°Ð½ÐµÐ»ÑŒ
const toggle = document.getElementById('toggleBar');
const roomUsers = document.getElementById('roomUsers');
let open = false;
toggle.onclick = () => {
    open = !open;
    roomUsers.style.display = open ? 'block' : 'none';
    toggle.textContent = open ? 'â¬‡' : 'â¬†';
}; = () => {
    open = !open;
    roomUsers.style.display = open ? 'block' : 'none';
    toggle.textContent = open ? 'â¬‡' : 'â¬†';
};
    typingEl.textContent = others.length ? others.join(', ') + ' Ð¿ÐµÑ‡Ð°Ñ‚Ð°ÐµÑ‚...' : '';
});

terminal.textContent = `CLI Chat Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½\nÐ’Ð°Ñˆ Ð½Ð¸Ðº: ${username}\n-------------------------\n`;
</script>
</body>
</html>
