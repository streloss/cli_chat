<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CLI Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;background:#000;color:#fff;font-family:monospace}
#typing{position:fixed;top:0;left:0;width:100%;padding:6px 12px;color:#0f0;background:#000;border-bottom:1px solid #222;z-index:10}
#terminal{padding:10px;padding-top:40px;padding-bottom:60px;height:100vh;overflow-y:auto;white-space:pre-wrap}
#input{position:fixed;bottom:28px;left:0;width:100%;background:#000;color:#fff;border:none;outline:none;font-family:monospace;font-size:16px;padding:6px 10px}
#connection{position:fixed;bottom:0;left:0;width:100%;padding:6px 12px;font-size:13px;background:#000;border-top:1px solid #222;color:#888}
</style>
</head>
<body>

<div id="typing"></div>
<div id="terminal"></div>
<input id="input" placeholder="Введите сообщение и нажмите Enter">
<div id="connection"></div>

<script>
// ===== KEYS =====
const ADMIN_KEY = 'ADMIN-1234';
const OWNER_KEY = 'OWNER-ROOT-9999';

// ===== STATE =====
let role = localStorage.getItem('role') || 'USER';
let userColor = localStorage.getItem('userColor') || '#ffffff';

// ===== ENCRYPTION =====
const CHAT_SECRET = 'CLI_CHAT_SECRET_2026'; // общий ключ

function encrypt(text){
  return btoa(text + '|' + CHAT_SECRET);
}

function decrypt(text){
  try{
    const decoded = atob(text);
    if(decoded.endsWith('|' + CHAT_SECRET)){
      return decoded.slice(0, -('|'+CHAT_SECRET).length);
    }
    return '[НЕ УДАЛОСЬ РАСШИФРОВАТЬ]';
  }catch(e){
    return '[ОШИБКА ШИФРОВАНИЯ]';
  }
}
    return '[НЕ УДАЛОСЬ РАСШИФРОВАТЬ]';
  }catch(e){
    return '[ОШИБКА ШИФРОВАНИЯ]';
  }
}

// ===== USER =====
let username = localStorage.getItem('nickname');
if(!username){
  username = prompt('Введите ваш ник:') || 'user_' + Math.floor(Math.random()*1000);
  localStorage.setItem('nickname', username);
}

// ===== FIREBASE =====
const firebaseConfig = {
  apiKey: "AIzaSyBzPbPhYS7dDfhDwaqYLAHpIV6QBN53EV0",
  authDomain: "project-7979939474542798395.firebaseapp.com",
  databaseURL: "https://project-7979939474542798395-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "project-7979939474542798395",
  storageBucket: "project-7979939474542798395.firebasestorage.app",
  messagingSenderId: "64773662070",
  appId: "1:64773662070:web:59a5ade363119a1b61c657"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const messagesRef = db.ref('messages');
const typingRef = db.ref('typing');
const ownerLogsRef = db.ref('owner_logs');

// ===== UI =====
const terminal = document.getElementById('terminal');
const input = document.getElementById('input');
const typingEl = document.getElementById('typing');
const connectionEl = document.getElementById('connection');

function system(msg){
  terminal.innerHTML += '<span style="color:#888">[SYSTEM]</span> ' + msg + '<br>';
}

// ===== RENDER =====
messagesRef.limitToLast(100).on('value', function(snap){
  terminal.innerHTML = '';
  const data = snap.val() || {};
  Object.values(data).forEach(function(m){
    let tag = '';
    if(m.role === 'OWNER') tag = '<span style="color:red;font-weight:bold">[OWNER]</span> ';
    else if(m.role === 'ADMIN') tag = '<span style="color:red">[ADMIN]</span> ';

    terminal.innerHTML += '[' + m.time + '] ' + tag + '<span style="color:' + m.color + '">' + m.user + '</span>: ' + decrypt(m.text) + '<br>';
  });
  terminal.scrollTop = terminal.scrollHeight;
});

// ===== INPUT =====
input.addEventListener('keydown', function(e){
  if(e.key !== 'Enter') return;
  const text = input.value.trim();
  if(!text) return;

  if(text.indexOf('/color ') === 0){
    userColor = text.slice(7).trim();
    localStorage.setItem('userColor', userColor);
    input.value = '';
    return;
  }

  if(text.indexOf('/key ') === 0){
    const key = text.slice(5).trim();
    if(key === OWNER_KEY){
      role = 'OWNER';
      localStorage.setItem('role','OWNER');
      ownerLogsRef.push({user:username,time:new Date().toLocaleString()});
      system('Вы вошли как OWNER');
    } else if(key === ADMIN_KEY){
      role = 'ADMIN';
      localStorage.setItem('role','ADMIN');
      system('Вы вошли как ADMIN');
    } else {
      system('Неверный ключ');
    }
    input.value = '';
    return;
  }

  if(text === '/ownerlogs'){
    if(role !== 'OWNER'){
      system('Доступ запрещён');
      input.value = '';
      return;
    }
    ownerLogsRef.limitToLast(20).once('value', function(snap){
      system('Последние входы OWNER:');
      snap.forEach(function(c){
        const d = c.val();
        terminal.innerHTML += '<span style="color:red">[OWNER]</span> ' + d.user + ' | ' + d.time + '<br>';
      });
    });
    input.value = '';
    return;
  }

  if(text === '/clear'){
    if(role === 'OWNER' || role === 'ADMIN') messagesRef.remove();
    input.value = '';
    return;
  }

  messagesRef.push({
    user: username,
    role: role,
    text: encrypt(text),
    time: new Date().toLocaleTimeString(),
    color: userColor
  });

  input.value = '';
  typingRef.child(username).remove();
});

input.addEventListener('input', function(){
  typingRef.child(username).set(true);
  setTimeout(function(){ typingRef.child(username).remove(); },1500);
});

typingRef.on('value', function(snap){
  const users = snap.val() || {};
  const list = Object.keys(users).filter(function(n){ return n !== username; });
  typingEl.textContent = list.length ? list.join(', ') + ' печатает...' : '';
});

// ===== CONNECTION + PING =====
let lastPing = 0;

function updatePing(){
  const start = performance.now();
  db.ref('ping').set(Date.now()).then(function(){
    const ms = Math.round(performance.now() - start);
    connectionEl.textContent = '● Подключено | ping: ' + ms + ' ms';
    connectionEl.style.color = '#0f0';
  });
}).catch(function(){
    connectionEl.textContent = '● Подключено | ping: ?';
    connectionEl.style.color = '#0f0';
  });
}

db.ref('.info/connected').on('value', function(snap){
  if(snap.val()){
    updatePing();
  } else {
    connectionEl.textContent = '● Соединение потеряно';
    connectionEl.style.color = '#f00';
  }
});

setInterval(function(){
  if(navigator.onLine){
    updatePing();
  }
}, 5000);

terminal.innerHTML = 'CLI Chat started<br>Ваш ник: ' + username + '<br>-------------------------<br>';

