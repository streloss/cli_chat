<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CLI Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;background:#000;color:#fff;font-family:monospace}
#terminal{padding:10px;height:calc(100vh - 120px);overflow-y:auto}
#typing{position:fixed;bottom:60px;left:0;width:100%;padding:6px 10px;color:#888;font-size:14px;background:#000;border-top:1px solid #222;z-index:10}
#input{position:fixed;bottom:20px;left:0;width:100%;background:#000;color:#fff;border:none;outline:none;font-family:monospace;font-size:16px;padding:5px 10px}
</style>
</head>
<body>

<div id="terminal"></div>
<div id="typing"></div>
<input id="input" placeholder="Введите сообщение и нажмите Enter">

<script>
// ===== SETTINGS =====
var ADMIN_KEY = 'CHANGE_ME_123';
var isAdmin = localStorage.getItem('isAdmin') === 'true';
var userColor = localStorage.getItem('userColor') || '#ffffff';

// ===== USER =====
var username = localStorage.getItem('nickname');
if(!username){
  username = prompt('Введите ваш ник:');
  if(!username) username = 'user_' + Math.floor(Math.random()*1000);
  localStorage.setItem('nickname', username);
}

// ===== FIREBASE =====
var firebaseConfig = {
  apiKey: "AIzaSyBzPbPhYS7dDfhDwaqYLAHpIV6QBN53EV0",
  authDomain: "project-7979939474542798395.firebaseapp.com",
  databaseURL: "https://project-7979939474542798395-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "project-7979939474542798395",
  storageBucket: "project-7979939474542798395.firebasestorage.app",
  messagingSenderId: "64773662070",
  appId: "1:64773662070:web:59a5ade363119a1b61c657"
};

firebase.initializeApp(firebaseConfig);
var db = firebase.database();
var messagesRef = db.ref('messages');
var typingRef = db.ref('typing');

// ===== UI =====
var terminal = document.getElementById('terminal');
var input = document.getElementById('input');
var typingEl = document.getElementById('typing');

// ===== RENDER =====
function renderMessages(data){
  terminal.innerHTML = '';
  for(var k in data){
    var m = data[k];
    var nameHtml = '';

    if(m.user && m.user.indexOf('[ADMIN] ') === 0){
      var clean = m.user.replace('[ADMIN] ','');
      nameHtml = `<span style="color:red;font-weight:bold">[ADMIN]</span> <span style="color:${m.color || '#ffffff'}">${clean}</span>`;
    } else {
      nameHtml = `<span style="color:${m.color || '#ffffff'}">${m.user}</span>`;
    }

    terminal.innerHTML += `[${m.time}] ${nameHtml}: ${m.text}<br>`;
  }
  terminal.scrollTop = terminal.scrollHeight;
}

messagesRef.limitToLast(100).on('value', function(snap){
  renderMessages(snap.val() || {});
});

// ===== INPUT =====
input.addEventListener('keydown', function(e){
  if(e.key !== 'Enter') return;
  var text = input.value.trim();
  if(!text) return;

  if(text.startsWith('/color ')){
    userColor = text.slice(7).trim();
    localStorage.setItem('userColor', userColor);
    input.value = '';
    return;
  }

  if(text.startsWith('/key ')){
    if(text.slice(5).trim() === ADMIN_KEY){
      isAdmin = true;
      localStorage.setItem('isAdmin','true');
    }
    input.value = '';
    return;
  }

  if(text === '/clear'){
    if(isAdmin) messagesRef.remove();
    input.value = '';
    return;
  }

  messagesRef.push({
    user:(isAdmin ? '[ADMIN] ' : '') + username,
    text:text,
    time:new Date().toLocaleTimeString(),
    color:userColor
  });

  input.value = '';
  typingRef.child(username).remove();
});

input.addEventListener('input', function(){
  typingRef.child(username).set(true);
  setTimeout(function(){ typingRef.child(username).remove(); },1500);
});

typingRef.on('value', function(snap){
  var users = snap.val() || {};
  var list = [];
  for(var u in users){ if(u !== username) list.push(u); }
  typingEl.textContent = list.length ? list.join(', ') + ' печатает...' : '';
});

terminal.textContent = 'CLI Chat started\nВаш ник: ' + username + '\n-------------------------\n';
</script>
</body>
</html>
