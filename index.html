<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CLI Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
* { box-sizing:border-box; margin:0; padding:0; }
body { background:#0a0a0a; color:#e0e0e0; font-family:monospace; height:100vh; overflow:hidden; }
#top-bar { position:fixed; top:0; left:0; right:0; height:48px; background:#111; border-bottom:1px solid #222; display:flex; align-items:center; justify-content:space-between; padding:0 16px; z-index:20; }
#menu-btn { cursor:pointer; font-size:22px; color:#0af; }
#title { font-size:16px; font-weight:bold; }
#online { cursor:pointer; color:#0f0; font-weight:bold; margin-left:20px; }
#lobby-icon { cursor:pointer; font-size:20px; color:#0f0; }
#sidebar { position:fixed; left:0; top:48px; bottom:0; width:260px; background:#111; border-right:1px solid #222; padding:20px; transform:translateX(-100%); transition:transform 0.3s ease; z-index:15; overflow-y:auto; }
#sidebar.open { transform:translateX(0); }
.sidebar-title { font-size:15px; color:#aaa; margin-bottom:12px; }
#friends-list, #rooms-list { font-size:14px; line-height:1.6; }
.friend, .room { margin:6px 0; cursor:pointer; }
#friends-input, #new-room-password { width:100%; background:#1a1a1a; color:#fff; border:1px solid #333; border-radius:4px; padding:8px; margin-top:8px; }
#add-friend-btn, #create-room-btn { background:#0af; color:#0a0a0a; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; margin-top:8px; width:100%; }
#terminal { padding:56px 16px 100px; height:100vh; overflow-y:auto; background:#0a0a0a; }
.message { margin:10px 0; white-space:pre-wrap; word-break:break-word; }
.time { color:#555; margin-right:6px; }
.creator-tag { color:#ff6666; font-size:14px; font-weight:bold; margin-right:6px; }
.nick { font-weight:bold; margin-right:4px; }
.separator { color:#555; margin:0 4px; }
#input-area { position:fixed; bottom:36px; left:0; right:0; padding:12px 16px; background:#0a0a0a; border-top:1px solid #222; }
#input { width:100%; background:#1a1a1a; color:#fff; border:1px solid #333; border-radius:8px; padding:12px 16px; font-size:16px; outline:none; }
#status { position:fixed; bottom:0; left:0; right:0; height:36px; background:#111; color:#888; font-size:13px; display:flex; align-items:center; padding:0 16px; border-top:1px solid #222; }
#typing { position:fixed; bottom:76px; left:16px; color:#777; font-size:13px; display:none; }
#onlineList { display:none; position:absolute; top:48px; left:50%; transform:translateX(-50%); background:#111; border:1px solid #333; border-radius:8px; padding:12px; width:280px; max-height:400px; overflow-y:auto; box-shadow:0 10px 30px rgba(0,0,0,0.7); z-index:30; }
.ip-info { color:#888; font-size:11px; margin-left:8px; }
.flag { font-size:15px; margin-right:4px; }
</style>
</head>
<body>

<div id="top-bar">
  <span id="menu-btn">‚ò∞</span>
  <div id="title">CLI Chat</div>
  <span id="online">–í —Å–µ—Ç–∏: 0</span>
  <span id="lobby-icon">üè†</span>
</div>

<div id="onlineList"></div>

<div id="sidebar">
  <div class="sidebar-title">–î—Ä—É–∑—å—è</div>
  <div id="friends-list"></div>
  <input id="friends-input" placeholder="–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞ (–Ω–∏–∫)">
  <button id="add-friend-btn">–î–æ–±–∞–≤–∏—Ç—å</button>

  <div class="sidebar-title" style="margin-top:32px">–õ–æ–±–±–∏</div>
  <div id="rooms-list"></div>
  <input id="new-room-password" placeholder="–ü–∞—Ä–æ–ª—å –¥–ª—è –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã">
  <button id="create-room-btn">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
</div>

<div id="terminal"></div>

<div id="input-area">
  <input id="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ... (Enter)">
</div>

<div id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
<div id="typing">‚úçÔ∏è –∫—Ç–æ-—Ç–æ –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶</div>

<script>
// –§—É–Ω–∫—Ü–∏—è —Ñ–ª–∞–≥–∞ —Å—Ç—Ä–∞–Ω—ã
function getFlagEmoji(code) {
  if (!code || code.length !== 2) return '';
  return String.fromCodePoint(...code.toUpperCase().split('').map(c => 127397 + c.charCodeAt(0)));
}

// –ü–æ–ª—É—á–∞–µ–º –≥–µ–æ + IP
async function getGeoInfo() {
  try {
    const res = await fetch('https://ipapi.co/json/');
    const d = await res.json();
    return {
      ip: d.ip || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
      country: d.country_name || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
      countryCode: d.country_code || '',
      city: d.city || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
    };
  } catch { return { ip:'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', country:'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', countryCode:'', city:'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }; }
}

let myGeo = { ip:'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', country:'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', countryCode:'', city:'–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' };
getGeoInfo().then(g => myGeo = g);

window.addEventListener('load', () => {
  if (typeof firebase === 'undefined') return;

  const config = { /* —Ç–≤–æ–π config */ 
    apiKey: "AIzaSyBzPbPhYS7dDfhDwaqYLAHpIV6QBN53EV0",
    authDomain: "project-7979939474542798395.firebaseapp.com",
    databaseURL: "https://project-7979939474542798395-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "project-7979939474542798395",
    storageBucket: "project-7979939474542798395.firebasestorage.app",
    messagingSenderId: "64773662070",
    appId: "1:64773662070:web:59a5ade363119a1b61c657"
  };
  firebase.initializeApp(config);
  const db = firebase.database();

  let username = localStorage.getItem('nick') || prompt('–í–∞—à –Ω–∏–∫');
  localStorage.setItem('nick', username);
  let role = localStorage.getItem('role') || 'USER';
  const PASSWORD = 'sayayo';

  const friendsRef = db.ref('friends/' + username);
  const roomsRef = db.ref('rooms');
  const typingRef = db.ref('typing');
  const typingUserRef = db.ref('typing/' + username);
  const onlineRef = db.ref('online/' + username);

  onlineRef.set({
    username: username,
    role: role,
    geo: myGeo,
    time: Date.now(),
    device: navigator.userAgent.includes('Mobile') ? 'üì±' : 'üñ•Ô∏è'
  });
  onlineRef.onDisconnect().remove();

  const terminal = document.getElementById('terminal');
  const input = document.getElementById('input');
  const statusEl = document.getElementById('status');
  const typingEl = document.getElementById('typing');
  const sidebar = document.getElementById('sidebar');
  const menuBtn = document.getElementById('menu-btn');
  const onlineEl = document.getElementById('online');
  const onlineListEl = document.getElementById('onlineList');

  function system(msg) {
    terminal.innerHTML += `<div style="color:#777">[SYSTEM] ${msg}</div>`;
    terminal.scrollTop = terminal.scrollHeight;
  }

  // –°–ø–∏—Å–æ–∫ ¬´–í —Å–µ—Ç–∏¬ª
  db.ref('online').on('value', snap => {
    const users = snap.val() || {};
    let count = 0;
    let html = '';
    for (let uid in users) {
      const u = users[uid];
      if (!u) continue;
      count++;

      let line = (u.username || uid);

      // –§–ª–∞–≥ + —Å—Ç—Ä–∞–Ω–∞ + –≥–æ—Ä–æ–¥ (–≤–∏–¥—è—Ç –≤—Å–µ)
      if (u.geo && u.geo.country !== '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') {
        const flag = getFlagEmoji(u.geo.countryCode);
        line += ` <span class="flag">${flag}</span> ${u.geo.country}, ${u.geo.city}`;
      }

      // IP ‚Äî —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã
      if ((role === 'ADMIN' || role === 'OWNER') && u.geo?.ip) {
        line += ` <span class="ip-info">[IP: ${u.geo.ip}]</span>`;
      }

      html += `<div>${line}</div>`;
    }
    onlineEl.textContent = `–í —Å–µ—Ç–∏: ${count}`;
    onlineListEl.innerHTML = html || '(–ø—É—Å—Ç–æ)';
  });

  onlineEl.onclick = () => {
    onlineListEl.style.display = onlineListEl.style.display === 'block' ? 'none' : 'block';
  };

  // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ (—Å–æ–æ–±—â–µ–Ω–∏—è, –¥—Ä—É–∑—å—è, –ª–æ–±–±–∏, –≤–≤–æ–¥) ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
  // (—è –æ—Å—Ç–∞–≤–∏–ª —Ç–≤–æ–π –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–∞–ª—å—à–µ, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏–ª –æ–Ω–ª–∞–π–Ω)

  let currentRoomId = null;
  let messagesRef = db.ref('messages');
  const params = new URLSearchParams(window.location.search);
  currentRoomId = params.get('room');
  const enteredPassword = params.get('password');
  if (currentRoomId) {
    messagesRef = db.ref('rooms/' + currentRoomId + '/messages');
    db.ref('rooms/' + currentRoomId + '/password').once('value', snap => {
      if (snap.val() !== enteredPassword) system('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω: –Ω–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
      else system('–í—ã –≤ –ø—Ä–∏–≤–∞—Ç–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ ' + currentRoomId);
    });
  }

  // ... (–≤–µ—Å—å —Ç–≤–æ–π –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Å –¥—Ä—É–∑—å—è–º–∏, –ª–æ–±–±–∏, –≤–≤–æ–¥–æ–º, typing –∏ —Ç.–¥. ‚Äî –æ—Å—Ç–∞–≤—å –∫–∞–∫ –±—ã–ª–æ)

  // (–î–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞ —è –Ω–µ –¥—É–±–ª–∏—Ä—É—é –≤–µ—Å—å —Ç–≤–æ–π –±–æ–ª—å—à–æ–π –±–ª–æ–∫ –Ω–∏–∂–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤—Å—Ç–∞–≤—å —ç—Ç–æ—Ç –∫–æ–¥ –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ)
});
</script>
</body>
</html>
