<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CLI Chat v2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;background:#000;color:#fff;font-family:monospace}
#top{position:fixed;top:0;left:0;width:100%;padding:6px 10px;border-bottom:1px solid #222;background:#000;z-index:10}
#online{cursor:pointer;color:#0f0}
#onlineList{display:none;font-size:13px;color:#aaa}
#terminal{padding:50px 10px 70px;height:100vh;overflow-y:auto;white-space:pre-wrap}
#input{position:fixed;bottom:28px;left:0;width:100%;background:#000;color:#fff;border:none;outline:none;font-family:monospace;font-size:16px;padding:6px 10px}
#status{position:fixed;bottom:0;left:0;width:100%;padding:6px 10px;font-size:13px;border-top:1px solid #222;color:#888}
.tag-owner{color:red;font-weight:bold}
.tag-admin{color:red}
</style>
</head>
<body>

<div id="top">
  <span id="online">В сети: 0</span>
  <div id="onlineList"></div>
</div>

<div id="terminal"></div>
<input id="input" placeholder="Введите сообщение и Enter">
<div id="status">● Подключение...</div>

<script>
// ===== CONFIG =====
const PASSWORD = 'sayayo';

const firebaseConfig = {
  apiKey: "AIzaSyBzPbPhYS7dDfhDwaqYLAHpIV6QBN53EV0",
  authDomain: "project-7979939474542798395.firebaseapp.com",
  databaseURL: "https://project-7979939474542798395-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "project-7979939474542798395",
  storageBucket: "project-7979939474542798395.firebasestorage.app",
  messagingSenderId: "64773662070",
  appId: "1:64773662070:web:59a5ade363119a1b61c657"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== STATE =====
let role = localStorage.getItem('role') || 'USER';
let username = localStorage.getItem('nick');
let nameColor = localStorage.getItem('nameColor');

if(!username){
  username = prompt('Введите ник');
  localStorage.setItem('nick', username);
}

if(!nameColor){
  const colors = ['#ff5555','#55ff55','#5555ff','#ffaa00','#00ffaa','#aa00ff','#ff00aa','#00aaff'];
  nameColor = colors[Math.floor(Math.random()*colors.length)];
  localStorage.setItem('nameColor', nameColor);
}

// ===== REFS =====
const messagesRef = db.ref('messages');
const onlineRef = db.ref('online/' + username);

// ===== UI =====
const terminal = document.getElementById('terminal');
const input = document.getElementById('input');
const statusEl = document.getElementById('status');
const onlineEl = document.getElementById('online');
const onlineListEl = document.getElementById('onlineList');

function system(msg){
  terminal.innerHTML += '[SYSTEM] ' + msg + '
';
}

// ===== ONLINE =====
onlineRef.set(true);
onlineRef.onDisconnect().remove();

db.ref('online').on('value', function(snap){
  const users = snap.val() || {};
  const list = Object.keys(users);
  onlineEl.textContent = 'В сети: ' + list.length;
  onlineListEl.textContent = list.join(', ');
});

onlineEl.onclick = function(){
  onlineListEl.style.display = onlineListEl.style.display === 'block' ? 'none' : 'block';
};

// ===== MESSAGES =====
messagesRef.limitToLast(100).on('child_added', function(snap){
  const m = snap.val();
  let tag = '';
  if(m.role === 'OWNER') tag = '<span class="tag-owner">[OWNER]</span> ';
  else if(m.role === 'ADMIN') tag = '<span class="tag-admin">[ADMIN]</span> ';

  terminal.innerHTML += '[' + m.time + '] ' + tag + '<span style="color:' + m.color + '">' + m.user + '</span>: ' + m.text + '
';
  terminal.scrollTop = terminal.scrollHeight;
});

// ===== INPUT =====
input.addEventListener('keydown', function(e){
  if(e.key !== 'Enter') return;
  const text = input.value.trim();
  if(!text) return;

  if(text.startsWith('/key ')){
    const p = text.split(' ');
    if(p[2] !== PASSWORD){ system('Неверный пароль'); input.value=''; return; }
    if(p[1] === 'owner'){ role='OWNER'; localStorage.setItem('role','OWNER'); system('Вы OWNER'); }
    else if(p[1] === 'admin'){ role='ADMIN'; localStorage.setItem('role','ADMIN'); system('Вы ADMIN'); }
    input.value=''; return;
  }

  if(text === '/clear'){
    if(role === 'OWNER' || role === 'ADMIN') messagesRef.remove();
    else system('Нет прав');
    input.value=''; return;
  }

  if(text.startsWith('/ban ')){
    if(role !== 'OWNER'){ system('Только OWNER'); input.value=''; return; }
    const nick = text.slice(5);
    db.ref('bans/' + nick).set(true);
    system('Пользователь забанен');
    input.value=''; return;
  }

  db.ref('bans/' + username).once('value', function(s){
    if(s.exists()){ alert('Вы забанены'); return; }
    messagesRef.push({
      user: username,
      role: role,
      text: text,
      time: new Date().toLocaleTimeString(),
      color: nameColor
    });
  });

  input.value='';
});

// ===== CONNECTION =====
db.ref('.info/connected').on('value', function(snap){
  if(snap.val()){
    statusEl.textContent = '● Подключено';
    statusEl.style.color = '#0f0';
  } else {
    statusEl.textContent = '● Соединение потеряно';
    statusEl.style.color = '#f00';
  }
});
</script>
</body>
</html>
