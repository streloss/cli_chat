<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CLI Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body {
  margin: 0;
  background: black;
  color: #fff;
  font-family: monospace;
}
#terminal {
  padding: 10px;
  height: calc(100vh - 140px);
  overflow-y: auto;
  white-space: pre-wrap;
}
#typing {
  position: fixed;
  bottom: 80px;
  left: 0;
  width: 100%;
  padding: 5px 10px;
  font-size: 14px;
  color: #888;
  background: black;
}
#roomBar {
  position: fixed;
  bottom: 110px;
  left: 0;
  width: 100%;
  display: flex;
  justify-content: space-between;
  padding: 5px 10px;
  background: #111;
}
#roomUsers {
  display: none;
  position: fixed;
  bottom: 140px;
  left: 0;
  width: 100%;
  padding: 5px 10px;
  background: black;
  color: #aaa;
  font-size: 13px;
}
#input {
  position: fixed;
  bottom: 20px;
  left: 0;
  width: 100%;
  border: none;
  outline: none;
  background: black;
  color: #fff;
  font-family: monospace;
  font-size: 16px;
  padding: 5px 10px;
}
</style>
</head>
<body>

<div id="terminal"></div>
<div id="roomBar">
  <span id="roomCount">ðŸ‘¥ 0</span>
  <span id="toggleBar">â¬†</span>
</div>
<div id="roomUsers"></div>
<div id="typing"></div>
<input id="input" placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¸ Enter">

<script>
const terminal = document.getElementById('terminal');
const input = document.getElementById('input');
const typingEl = document.getElementById('typing');
const roomCountEl = document.getElementById('roomCount');
const roomUsersEl = document.getElementById('roomUsers');
const toggleBar = document.getElementById('toggleBar');

const username = 'user_' + Math.floor(Math.random() * 1000);

const firebaseConfig = {
  apiKey: "AIzaSyBzPbPhYS7dDfhDwaqYLAHpIV6QBN53EV0",
  authDomain: "project-7979939474542798395.firebaseapp.com",
  databaseURL: "https://project-7979939474542798395-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "project-7979939474542798395",
  storageBucket: "project-7979939474542798395.firebasestorage.app",
  messagingSenderId: "64773662070",
  appId: "1:64773662070:web:59a5ade363119a1b61c657"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const messagesRef = db.ref('messages');
const typingRef = db.ref('typing');
const presenceRef = db.ref('presence');

function renderMessages(data) {
  terminal.textContent = '';
  Object.values(data || {}).forEach(m => {
    terminal.textContent += `[${m.time}] ${m.user}: ${m.text}\n`;
  });
  terminal.scrollTop = terminal.scrollHeight;
}

messagesRef.limitToLast(100).on('value', snap => {
  renderMessages(snap.val());
});

input.addEventListener('keydown', e => {
  if (e.key !== 'Enter') return;
  const text = input.value.trim();
  if (!text) return;

  messagesRef.push({
    user: username,
    text,
    time: new Date().toLocaleTimeString()
  });

  input.value = '';
  typingRef.child(username).remove();
});

input.addEventListener('input', () => {
  typingRef.child(username).set(true);
  setTimeout(() => typingRef.child(username).remove(), 1500);
});

typingRef.on('value', snap => {
  const users = snap.val() || {};
  const list = Object.keys(users).filter(u => u !== username);
  typingEl.textContent = list.length ? list.join(', ') + ' Ð¿ÐµÑ‡Ð°Ñ‚Ð°ÐµÑ‚...' : '';
});

firebase.database().ref('.info/connected').on('value', snap => {
  if (snap.val()) {
    presenceRef.child(username).set(true);
    presenceRef.child(username).onDisconnect().remove();
  }
});

presenceRef.on('value', snap => {
  const users = snap.val() || {};
  const names = Object.keys(users);
  roomCountEl.textContent = `ðŸ‘¥ ${names.length}`;
  roomUsersEl.textContent = names.length ? 'Ð’ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ðµ: ' + names.join(', ') : 'Ð’ ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ðµ Ð½Ð¸ÐºÐ¾Ð³Ð¾ Ð½ÐµÑ‚';
});

let open = false;
toggleBar.onclick = () => {
  open = !open;
  roomUsersEl.style.display = open ? 'block' : 'none';
  toggleBar.textContent = open ? 'â¬‡' : 'â¬†';
};

terminal.textContent = `CLI Chat Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½\nÐ’Ð°Ñˆ Ð½Ð¸Ðº: ${username}\n-------------------------\n`;
</script>
</body>
</html>
