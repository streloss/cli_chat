<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CLI Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
* { box-sizing:border-box; }
body { 
  margin:0; 
  background:#0d0d0d; 
  color:#e0e0e0; 
  font-family:monospace; 
  height:100vh; 
  overflow:hidden; 
}
#sidebar {
  position:fixed;
  left:0; top:0; bottom:0;
  width:280px;
  background:#111;
  border-right:1px solid #222;
  padding:20px;
  transform:translateX(-100%);
  transition:transform 0.3s ease;
  z-index:100;
}
#sidebar.open { transform:translateX(0); }
#sidebar h2 { margin:0 0 16px; font-size:16px; color:#aaa; }
#friends-list { font-size:14px; color:#ccc; }
.friend { margin:8px 0; }
.friend.online::before { content:"‚óè "; color:#0f0; }

#top-bar {
  position:fixed;
  top:0; left:0; right:0;
  height:50px;
  background:#111;
  border-bottom:1px solid #222;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
  z-index:10;
}
#menu-btn { cursor:pointer; font-size:20px; color:#0af; }
#lobby-icon { cursor:pointer; font-size:20px; color:#0f0; }

#terminal {
  padding:60px 16px 100px;
  height:100vh;
  overflow-y:auto;
  background:#0d0d0d;
}
.message {
  margin:12px 0;
  line-height:1.4;
}
.time { color:#555; margin-right:8px; }
.nick { font-weight:bold; }
.creator-tag { 
  color:#ff6666; 
  font-size:14px; 
  font-weight:bold; 
  margin-right:6px; 
}
.text { color:#ffffff; }

#input-area {
  position:fixed;
  bottom:0; left:0; right:0;
  padding:16px;
  background:#0d0d0d;
  border-top:1px solid #222;
}
#input {
  width:100%;
  background:#1a1a1a;
  color:#fff;
  border:1px solid #333;
  border-radius:8px;
  padding:12px 16px;
  font-size:16px;
  outline:none;
}
#status {
  position:fixed;
  bottom:0; left:0; right:0;
  height:40px;
  background:#111;
  color:#888;
  font-size:13px;
  display:flex;
  align-items:center;
  padding:0 16px;
  border-top:1px solid #222;
}
#typing {
  position:fixed;
  bottom:40px;
  left:16px;
  color:#777;
  font-size:13px;
  display:none;
}
</style>
</head>
<body>

<div id="sidebar">
  <h2>–î—Ä—É–∑—å—è</h2>
  <div id="friends-list"></div>
  <h2 style="margin-top:32px">–õ–æ–±–±–∏</h2>
  <div>–ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–æ–º–Ω–∞—Ç—ã (—Å–∫–æ—Ä–æ)</div>
</div>

<div id="top-bar">
  <span id="menu-btn">‚ò∞</span>
  <div>CLI Chat</div>
  <span id="lobby-icon">üè†</span>
</div>

<div id="terminal"></div>

<div id="input-area">
  <input id="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ... (Enter)">
</div>

<div id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
<div id="typing">‚úçÔ∏è –∫—Ç–æ-—Ç–æ –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶</div>

<script>
window.addEventListener('load', () => {
  if (typeof firebase === 'undefined') return;

  const config = {
    apiKey: "AIzaSyBzPbPhYS7dDfhDwaqYLAHpIV6QBN53EV0",
    authDomain: "project-7979939474542798395.firebaseapp.com",
    databaseURL: "https://project-7979939474542798395-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "project-7979939474542798395",
    storageBucket: "project-7979939474542798395.firebasestorage.app",
    messagingSenderId: "64773662070",
    appId: "1:64773662070:web:59a5ade363119a1b61c657"
  };
  firebase.initializeApp(config);
  const db = firebase.database();

  let username = localStorage.getItem('nick') || prompt('–í–∞—à –Ω–∏–∫');
  localStorage.setItem('nick', username);
  let role = localStorage.getItem('role') || 'USER';
  const PASSWORD = 'sayayo';

  const messagesRef = db.ref('messages');
  const onlineRef = db.ref('online/' + username);
  const typingRef = db.ref('typing');
  const typingUserRef = db.ref('typing/' + username);

  onlineRef.set({device: getDevice(), time: Date.now()});
  onlineRef.onDisconnect().remove();

  const terminal = document.getElementById('terminal');
  const input = document.getElementById('input');
  const statusEl = document.getElementById('status');
  const typingEl = document.getElementById('typing');
  const sidebar = document.getElementById('sidebar');
  const menuBtn = document.getElementById('menu-btn');

  function getDevice() {
    return navigator.userAgent.includes('Mobile') ? 'üì±' : 'üñ•Ô∏è';
  }

  function system(msg) {
    terminal.innerHTML += `<div style="color:#777">[SYSTEM] ${msg}</div>`;
    terminal.scrollTop = terminal.scrollHeight;
  }

  // –û–Ω–ª–∞–π–Ω
  db.ref('online').on('value', snap => {
    const users = snap.val() || {};
    let count = Object.keys(users).length;
    document.getElementById('online').textContent = `–í —Å–µ—Ç–∏: ${count}`;
  });

  // –°–æ–æ–±—â–µ–Ω–∏—è ‚Äî –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç, —Ç–µ–≥ —Å–ª–µ–≤–∞
  messagesRef.limitToLast(100).on('child_added', snap => {
    const m = snap.val();
    if (!m?.user || !m?.text) return;

    let nickClass = m.role === 'OWNER' ? 'owner-nick' : m.role === 'ADMIN' ? 'admin-nick' : '';
    let tag = m.role === 'OWNER' ? '<span class="creator-tag">[—Å–æ–∑–¥–∞—Ç–µ–ª—å]</span>&nbsp;' : '';

    terminal.innerHTML += 
      '<div class="message">' +
        '<span class="time">[' + (m.time || '--:--') + ']</span> ' +
        tag +
        '<span class="nick ' + nickClass + '">' + m.user + '</span>' +
        '<span style="color:#555"> : </span>' +
        '<span class="text">' + m.text + '</span>' +
      '</div>';

    terminal.scrollTop = terminal.scrollHeight;
  });

  // –í–≤–æ–¥
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const t = input.value.trim();
      if (!t) return;
      typingUserRef.remove();

      if (t.startsWith('/key ')) {
        const p = t.split(' ');
        if (p[2] === PASSWORD) {
          role = p[1] === 'owner' ? 'OWNER' : p[1] === 'admin' ? 'ADMIN' : role;
          localStorage.setItem('role', role);
          system('–†–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞');
        } else system('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
        input.value = '';
        return;
      }

      if (t === '/clear' && (role === 'OWNER' || role === 'ADMIN')) {
        messagesRef.remove();
        terminal.innerHTML = '';
        system('–ß–∞—Ç –æ—á–∏—â–µ–Ω');
        input.value = '';
        return;
      }

      messagesRef.push({
        user: username,
        role,
        text: t,
        time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
      });
      input.value = '';
    } else if (e.key.length === 1 || e.key === 'Backspace') {
      typingUserRef.set(true);
      typingUserRef.onDisconnect().remove();
    }
  });

  // Typing –∏ —Å—Ç–∞—Ç—É—Å
  db.ref('.info/connected').on('value', s => {
    statusEl.innerHTML = s.val() ? '<span style="color:#0f0">‚óè –û–Ω–ª–∞–π–Ω</span>' : '<span style="color:#f44">‚óè –û—Ñ—Ñ–ª–∞–π–Ω</span>';
  });

  typingRef.on('value', s => {
    const others = Object.keys(s.val() || {}).filter(u => u !== username);
    typingEl.style.display = others.length ? 'block' : 'none';
    typingEl.textContent = others.length ? '‚úçÔ∏è –∫—Ç–æ-—Ç–æ –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶' : '';
  });

  // –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å
  menuBtn.onclick = () => sidebar.classList.toggle('open');
});
</script>
</body>
</html>
