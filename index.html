<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CLI Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
* { box-sizing:border-box; margin:0; padding:0; }
body { background:#0a0a0a; color:#e0e0e0; font-family:monospace; height:100vh; overflow:hidden; }
#top-bar { position:fixed; top:0; left:0; right:0; height:48px; background:#111; border-bottom:1px solid #222; display:flex; align-items:center; justify-content:space-between; padding:0 16px; z-index:20; }
#menu-btn { cursor:pointer; font-size:22px; color:#0af; }
#title { font-size:16px; font-weight:bold; }
#lobby-icon { cursor:pointer; font-size:20px; color:#0f0; }
#sidebar { position:fixed; left:0; top:48px; bottom:0; width:260px; background:#111; border-right:1px solid #222; padding:20px; transform:translateX(-100%); transition:transform 0.3s ease; z-index:15; overflow-y:auto; }
#sidebar.open { transform:translateX(0); }
.sidebar-title { font-size:15px; color:#aaa; margin-bottom:12px; }
#friends-list, #rooms-list { font-size:14px; line-height:1.6; }
.friend, .room { margin:6px 0; cursor:pointer; }
#friends-input, #new-room-password { width:100%; background:#1a1a1a; color:#fff; border:1px solid #333; border-radius:4px; padding:8px; margin-top:8px; }
#add-friend-btn, #create-room-btn { background:#0af; color:#0a0a0a; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; margin-top:8px; width:100%; }
#terminal { padding:56px 16px 100px; height:100vh; overflow-y:auto; background:#0a0a0a; }
.message { margin:10px 0; white-space:pre-wrap; word-break:break-word; }
.time { color:#555; margin-right:6px; }
.creator-tag { color:#ff6666; font-size:14px; font-weight:bold; margin-right:6px; }
.nick { font-weight:bold; margin-right:4px; }
.separator { color:#555; margin:0 4px; }
#input-area { position:fixed; bottom:36px; left:0; right:0; padding:12px 16px; background:#0a0a0a; border-top:1px solid #222; }
#input { width:100%; background:#1a1a1a; color:#fff; border:1px solid #333; border-radius:8px; padding:12px 16px; font-size:16px; outline:none; }
#status { position:fixed; bottom:0; left:0; right:0; height:36px; background:#111; color:#888; font-size:13px; display:flex; align-items:center; padding:0 16px; border-top:1px solid #222; }
#typing { position:fixed; bottom:76px; left:16px; color:#777; font-size:13px; display:none; }
</style>
</head>
<body>

<div id="top-bar">
  <span id="menu-btn">‚ò∞</span>
  <div id="title">CLI Chat</div>
  <span id="lobby-icon">üè†</span>
</div>

<div id="sidebar">
  <div class="sidebar-title">–î—Ä—É–∑—å—è</div>
  <div id="friends-list"></div>
  <input id="friends-input" placeholder="–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞ (–Ω–∏–∫)">
  <button id="add-friend-btn">–î–æ–±–∞–≤–∏—Ç—å</button>

  <div class="sidebar-title" style="margin-top:32px">–õ–æ–±–±–∏</div>
  <div id="rooms-list"></div>
  <input id="new-room-password" placeholder="–ü–∞—Ä–æ–ª—å –¥–ª—è –Ω–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã">
  <button id="create-room-btn">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
</div>

<div id="terminal"></div>

<div id="input-area">
  <input id="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ... (Enter)">
</div>

<div id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
<div id="typing">‚úçÔ∏è –∫—Ç–æ-—Ç–æ –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶</div>

<script>
window.addEventListener('load', () => {
  if (typeof firebase === 'undefined') {
    document.getElementById('status').innerHTML = '<span style="color:#f44">Firebase –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è</span>';
    return;
  }

  const config = {
    apiKey: "AIzaSyBzPbPhYS7dDfhDwaqYLAHpIV6QBN53EV0",
    authDomain: "project-7979939474542798395.firebaseapp.com",
    databaseURL: "https://project-7979939474542798395-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "project-7979939474542798395",
    storageBucket: "project-7979939474542798395.firebasestorage.app",
    messagingSenderId: "64773662070",
    appId: "1:64773662070:web:59a5ade363119a1b61c657"
  };
  firebase.initializeApp(config);
  const db = firebase.database();

  let username = localStorage.getItem('nick') || prompt('–í–∞—à –Ω–∏–∫');
  localStorage.setItem('nick', username);
  let role = localStorage.getItem('role') || 'USER';
  const PASSWORD = 'sayayo';

  const friendsRef = db.ref('friends/' + username);
  const roomsRef = db.ref('rooms');
  const typingRef = db.ref('typing');
  const typingUserRef = db.ref('typing/' + username);

  const terminal = document.getElementById('terminal');
  const input = document.getElementById('input');
  const statusEl = document.getElementById('status');
  const typingEl = document.getElementById('typing');
  const sidebar = document.getElementById('sidebar');
  const menuBtn = document.getElementById('menu-btn');
  const friendsList = document.getElementById('friends-list');
  const roomsList = document.getElementById('rooms-list');
  const friendsInput = document.getElementById('friends-input');
  const addFriendBtn = document.getElementById('add-friend-btn');
  const newRoomPassword = document.getElementById('new-room-password');
  const createRoomBtn = document.getElementById('create-room-btn');

  let currentRoomId = null;
  let messagesRef = db.ref('messages');

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ URL –Ω–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
  const params = new URLSearchParams(window.location.search);
  currentRoomId = params.get('room');
  const enteredPassword = params.get('password');
  if (currentRoomId) {
    messagesRef = db.ref('rooms/' + currentRoomId + '/messages');
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    db.ref('rooms/' + currentRoomId + '/password').once('value', snap => {
      if (snap.val() !== enteredPassword) {
        system('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω: –Ω–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
      } else {
        system('–í—ã –≤ –ø—Ä–∏–≤–∞—Ç–Ω–æ–π –∫–æ–º–Ω–∞—Ç–µ ' + currentRoomId);
      }
    });
  }

  onlineRef = db.ref('online/' + username);
  onlineRef.set({device: getDevice(), time: Date.now()});
  onlineRef.onDisconnect().remove();

  function getDevice() {
    return navigator.userAgent.includes('Mobile') ? 'üì±' : 'üñ•Ô∏è';
  }

  function system(msg) {
    terminal.innerHTML += `<div style="color:#777">[SYSTEM] ${msg}</div>`;
    terminal.scrollTop = terminal.scrollHeight;
  }

  // –°–æ–æ–±—â–µ–Ω–∏—è
  messagesRef.limitToLast(100).on('child_added', snap => {
    const m = snap.val();
    if (!m?.user || !m?.text) return;

    let nickClass = m.role === 'OWNER' ? 'owner-nick' : m.role === 'ADMIN' ? 'admin-nick' : '';
    let tag = m.role === 'OWNER' ? '<span class="creator-tag">[—Å–æ–∑–¥–∞—Ç–µ–ª—å]</span>&nbsp;' : '';

    terminal.innerHTML += 
      '<div class="message">' +
        '<span class="time">[' + (m.time || '--:--') + ']</span> ' +
        tag +
        '<span class="nick ' + nickClass + '">' + m.user + '</span>' +
        '<span class="separator"> : </span>' +
        '<span class="text">' + m.text + '</span>' +
      '</div>';

    terminal.scrollTop = terminal.scrollHeight;
  });

  // –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const t = input.value.trim();
      if (!t) return;
      typingUserRef.remove();

      if (t.startsWith('/key ')) {
        const p = t.split(' ');
        if (p.length < 3 || p[2] !== PASSWORD) {
          system('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
        } else {
          role = p[1] === 'owner' ? 'OWNER' : p[1] === 'admin' ? 'ADMIN' : role;
          localStorage.setItem('role', role);
          system('–†–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞');
        }
        input.value = '';
        return;
      }

      if (t === '/clear' && (role === 'OWNER' || role === 'ADMIN')) {
        messagesRef.remove();
        terminal.innerHTML = '';
        system('–ß–∞—Ç –æ—á–∏—â–µ–Ω');
        input.value = '';
        return;
      }

      messagesRef.push({
        user: username,
        role,
        text: t,
        time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
      });
      input.value = '';
    } else if (e.key.length === 1 || e.key === 'Backspace') {
      typingUserRef.set(true);
      typingUserRef.onDisconnect().remove();
    }
  });

  // –°—Ç–∞—Ç—É—Å –∏ typing
  db.ref('.info/connected').on('value', s => {
    statusEl.innerHTML = s.val() ? '<span style="color:#0f0">‚óè –û–Ω–ª–∞–π–Ω</span>' : '<span style="color:#f44">‚óè –û—Ñ—Ñ–ª–∞–π–Ω</span>';
  });

  typingRef.on('value', s => {
    const others = Object.keys(s.val() || {}).filter(u => u !== username);
    typingEl.style.display = others.length ? 'block' : 'none';
    typingEl.textContent = others.length ? '‚úçÔ∏è –∫—Ç–æ-—Ç–æ –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶' : '';
  });

  // –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å
  menuBtn.onclick = () => sidebar.classList.toggle('open');

  // –î—Ä—É–∑—å—è
  let friends = [];
  friendsRef.on('value', snap => {
    friends = snap.val() || [];
    friendsList.innerHTML = friends.map(f => `<div class="friend">${f}</div>`).join('');
  });

  addFriendBtn.onclick = () => {
    const friend = friendsInput.value.trim();
    if (friend && !friends.includes(friend)) {
      friends.push(friend);
      friendsRef.set(friends);
      system(`–î–æ–±–∞–≤–ª–µ–Ω –¥—Ä—É–≥: ${friend}`);
      friendsInput.value = '';
    }
  };

  // –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –ª–æ–±–±–∏
  let rooms = [];
  roomsRef.on('value', snap => {
    roomsList.innerHTML = '';
    snap.forEach(child => {
      const room = child.val();
      const roomId = child.key;
      roomsList.innerHTML += `<div class="room" onclick="joinRoom('${roomId}')">${room.name || '–ö–æ–º–Ω–∞—Ç–∞ ' + roomId} (–∞–≤—Ç–æ—Ä: ${room.author})</div>`;
    });
  });

  createRoomBtn.onclick = () => {
    const pass = newRoomPassword.value.trim();
    if (!pass) {
      system('–£–∫–∞–∂–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
      return;
    }

    const roomId = roomsRef.push().key;
    roomsRef.child(roomId).set({
      author: username,
      password: pass,
      name: '–ö–æ–º–Ω–∞—Ç–∞ ' + username,
      created: Date.now()
    });

    system(`–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!`);
    system(`ID –∫–æ–º–Ω–∞—Ç—ã: ${roomId}`);
    system(`–ü–∞—Ä–æ–ª—å: ${pass}`);
    system(`–°—Å—ã–ª–∫–∞ –¥–ª—è –¥—Ä—É–∑–µ–π: ${window.location.origin}${window.location.pathname}?room=${roomId}&password=${pass}`);
    newRoomPassword.value = '';
  };

  window.joinRoom = (roomId) => {
    const pass = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∫–æ–º–Ω–∞—Ç—ã');
    if (!pass) return;

    db.ref('rooms/' + roomId + '/password').once('value', snap => {
      if (snap.val() === pass) {
        window.location.href = `?room=${roomId}&password=${pass}`;
      } else {
        system('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
      }
    });
  };
});
</script>
</body>
</html>
