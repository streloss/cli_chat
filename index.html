<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>CLI Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
body{margin:0;background:#000;color:#fff;font-family:monospace;line-height:1.4}
#top{position:fixed;top:0;left:0;width:100%;padding:8px 12px;border-bottom:1px solid #222;background:#000;z-index:10}
#online{cursor:pointer;color:#0f0}
#onlineList{display:none;font-size:13px;color:#aaa;padding-top:6px}
#terminal{padding:60px 12px 120px;height:100vh;overflow-y:auto;white-space:pre-wrap}
#input{position:fixed;bottom:28px;left:0;width:100%;background:#000;color:#fff;border:none;outline:none;font-family:monospace;font-size:16px;padding:8px 12px}
#status{position:fixed;bottom:0;left:0;width:100%;padding:6px 12px;font-size:13px;border-top:1px solid #222;color:#888}
.creator-tag{color:#ff5555;font-size:11px;margin-left:4px;vertical-align:super}
.admin-nick{color:#ffaaaa;font-weight:bold}
.owner-nick{color:#ff4444;font-weight:bold}
</style>
</head>
<body>

<div id="top"><span id="online">–í —Å–µ—Ç–∏: 0</span><div id="onlineList"></div></div>
<div id="terminal"></div>
<input id="input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ ‚Üí Enter">
<div id="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
<div id="typing" style="font-size:13px;color:#777;padding:4px 12px;display:none;position:fixed;bottom:60px;left:0;width:100%">‚úçÔ∏è –∫—Ç–æ-—Ç–æ –ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶</div>

<script>
window.addEventListener('load',()=>{if(typeof firebase==='undefined')return;

const fc={apiKey:"AIzaSyBzPbPhYS7dDfhDwaqYLAHpIV6QBN53EV0",authDomain:"project-7979939474542798395.firebaseapp.com",databaseURL:"https://project-7979939474542798395-default-rtdb.europe-west1.firebasedatabase.app",projectId:"project-7979939474542798395",storageBucket:"project-7979939474542798395.firebasestorage.app",messagingSenderId:"64773662070",appId:"1:64773662070:web:59a5ade363119a1b61c657"};
firebase.initializeApp(fc);const db=firebase.database();

const getDev=()=>{const ua=navigator.userAgent.toLowerCase();let os='Unknown',icon='üñ•Ô∏è',t='Desktop';
if(navigator.userAgentData?.platform){const p=navigator.userAgentData.platform.toLowerCase();if(p==='windows')os='Windows',icon='ü™ü';else if(p==='macos')os='macOS',icon='üçé';else if(p==='linux')os='Linux',icon='üêß';else if(p==='android')os='Android',icon='ü§ñ',t='Mobile';else if(p==='ios')os='iOS',icon='üçè',t='Mobile';}
else{if(ua.includes('windows'))os='Windows',icon='ü™ü';else if(ua.includes('mac os')||ua.includes('macintosh'))os='macOS',icon='üçé';else if(ua.includes('linux')&&!ua.includes('android'))os='Linux',icon='üêß';else if(ua.includes('android'))os='Android',icon='ü§ñ',t='Mobile';else if(/iphone|ipad|ipod/.test(ua))os='iOS',icon='üçè',t='Mobile';}
if('ontouchstart'in window||navigator.maxTouchPoints>0)t=(window.innerWidth||screen.width)>=900?'Tablet':'Phone';
return `${icon} ${os} (${t})`;};

const pw='sayayo';
let un=localStorage.getItem('nick')||prompt('–ù–∏–∫');localStorage.setItem('nick',un);
let rl=localStorage.getItem('role')||'USER';
let col=localStorage.getItem('color')||['#ff5555','#55ff55','#88aaff','#ffaa55','#55ffcc','#cc55ff','#ff88cc','#88ffff'][Math.floor(Math.random()*8)];
localStorage.setItem('color',col);

const msgRef=db.ref('messages'),onRef=db.ref('online/'+un),dev=getDev();
const typRef=db.ref('typing'),typURef=db.ref('typing/'+un),typEl=document.getElementById('typing');

onRef.set({device:dev,time:Date.now()});onRef.onDisconnect().remove();

const term=document.getElementById('terminal'),inp=document.getElementById('input'),st=document.getElementById('status'),onl=document.getElementById('online'),onlL=document.getElementById('onlineList');

db.ref('online').on('value',s=>{const u=s.val()||{},l=[],c=0;for(const k in u){if(u[k]?.device)l.push(`${k} <span style="color:#0c0">${u[k].device}</span>`),c++;}
onl.textContent=`–í —Å–µ—Ç–∏: ${c}`;onlL.innerHTML=l.length?l.join('<br>'):'(–ø—É—Å—Ç–æ)';});
onl.onclick=()=>{onlL.style.display=onlL.style.display==='block'?'none':'block';};

msgRef.limitToLast(100).on('child_added',s=>{const m=s.val();if(!m?.user||!m?.text)return;
let cls='',tag='';if(m.role==='OWNER'){cls='owner-nick';tag='<span class="creator-tag">[—Å–æ–∑–¥–∞—Ç–µ–ª—å]</span>';}
else if(m.role==='ADMIN')cls='admin-nick';
const txt=String(m.text).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
term.innerHTML+=`<div><span style="color:#555">[${m.time||'--:--'}]&nbsp;</span><span class="${cls}">${m.user}${tag}</span><span style="color:#888">&nbsp;:&nbsp;</span><span style="color:${m.color||'#fff'}">${txt}</span></div>`;
term.scrollTop=term.scrollHeight;});

inp.addEventListener('keydown',e=>{if(e.key==='Enter'){const t=inp.value.trim();if(!t)return;typURef.remove();
if(t.startsWith('/key ')){const p=t.split(' ');if(p.length<3||p[2]!==pw){term.innerHTML+=`<div style="color:#777">[SYSTEM] –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>`;}else{if(p[1]==='owner'){rl='OWNER';localStorage.setItem('role','OWNER');term.innerHTML+=`<div style="color:#777">[SYSTEM] –í—ã OWNER</div>`;}else if(p[1]==='admin'){rl='ADMIN';localStorage.setItem('role','ADMIN');term.innerHTML+=`<div style="color:#777">[SYSTEM] –í—ã ADMIN</div>`;}}inp.value='';return;}
if(t==='/clear'&&(rl==='OWNER'||rl==='ADMIN')){msgRef.remove();term.innerHTML='';term.innerHTML+=`<div style="color:#777">[SYSTEM] –ß–∞—Ç –æ—á–∏—â–µ–Ω</div>`;inp.value='';return;}
msgRef.push({user:un,role:rl,text:t,time:new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),color:col});inp.value='';}
else if(e.key.length===1||e.key==='Backspace'){typURef.set(true);typURef.onDisconnect().remove();}});

db.ref('.info/connected').on('value',s=>{st.innerHTML=s.val()?'<span style="color:#0f0">‚óè –û–Ω–ª–∞–π–Ω</span>':'<span style="color:#f44">‚óè –û—Ñ—Ñ–ª–∞–π–Ω</span>';});
typRef.on('value',s=>{const o=Object.keys(s.val()||{}).filter(u=>u!==un);typEl.textContent=o.length?'‚úçÔ∏è –ü–µ—á–∞—Ç–∞–µ—Ç: '+o.join(', '):'';typEl.style.display=o.length?'block':'none';});
});
</script>
</body>
</html>
